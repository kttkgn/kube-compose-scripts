apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config  # ConfigMap åç§°ï¼Œéœ€ä¸ Deployment å…³è”
  namespace: default  # å‘½åç©ºé—´ï¼ˆé»˜è®¤ defaultï¼Œå¯æ ¹æ®éœ€æ±‚ä¿®æ”¹ï¼‰
data:
  # Nginx ä¸»é…ç½®æ–‡ä»¶å†…å®¹
  nginx.conf: |
    user  nginx;
    worker_processes  auto;  # è‡ªåŠ¨é€‚é… CPU æ ¸å¿ƒæ•°

    error_log  /var/log/nginx/error.log notice;
    pid        /var/run/nginx.pid;

    events {
        worker_connections  1024;
    }

    http {
        include       /etc/nginx/mime.types;
        default_type  application/octet-stream;

        log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                          '$status $body_bytes_sent "$http_referer" '
                          '"$http_user_agent" "$http_x_forwarded_for"';

        access_log  /var/log/nginx/access.log  main;

        sendfile        on;
        # tcp_nopush     on;

        keepalive_timeout  65;

        # è‡ªå®šä¹‰åå‘ä»£ç†ç¤ºä¾‹ï¼ˆå¯æ ¹æ®éœ€æ±‚ä¿®æ”¹ï¼‰
        server {
            listen       80;  # Nginx ç›‘å¬ç«¯å£
            server_name  localhost;  # æœåŠ¡åŸŸåï¼ˆé›†ç¾¤å†…å¯å¡« Service åç§°ï¼‰

            location / {
                root   /usr/share/nginx/html;  # Nginx é»˜è®¤é™æ€èµ„æºç›®å½•
                index  index.html index.htm;
            }

            # åå‘ä»£ç†åˆ°é›†ç¾¤å†…å…¶ä»–æœåŠ¡ï¼ˆç¤ºä¾‹ï¼šä»£ç†åˆ°åä¸º "api-service" çš„ Serviceï¼‰
            location /api/ {
                proxy_pass http://api-service:8080/;  # æ ¼å¼ï¼šhttp://<Serviceåç§°>:<Serviceç«¯å£>/
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
            }

            error_page   500 502 503 504  /50x.html;
            location = /50x.html {
                root   /usr/share/nginx/html;
            }
        }
    }

  # Nginx é™æ€é¡µé¢ç¤ºä¾‹ï¼ˆå¯é€‰ï¼Œç”¨äºæµ‹è¯•è®¿é—®ï¼‰
  index.html: |
    <!DOCTYPE html>
    <html>
    <head>
        <title>K8s Nginx Service</title>
        <style>
            body { width: 100%; height: 100vh; display: flex; justify-content: center; align-items: center; font-family: Arial; }
        </style>
    </head>
    <body>
        <h1>Hello! Nginx is Running on Kubernetes ğŸš€</h1>
        <p>Deployed via k8s ConfigMap & Deployment</p>
    </body>
    </html>
